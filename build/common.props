<Project>
  <Import Project=".\package.props" />
  <PropertyGroup>
    <TargetFramework>netstandard2.0</TargetFramework>
    <LangVersion>latest</LangVersion>
    <MajorVersion>3</MajorVersion>
    <MinorVersion>22</MinorVersion>
    <PatchVersion>0</PatchVersion>
    <VersionPrefix>$(MajorVersion).$(MinorVersion).$(PatchVersion)</VersionPrefix>
    <Version Condition=" '$(BuildNumber)' != '' ">$(VersionPrefix)-$(BuildNumber)</Version>
    <Version Condition=" '$(Version)' == '' ">$(VersionPrefix)</Version>
    <AssemblyVersion>$(MajorVersion).$(MinorVersion).0.0</AssemblyVersion>
    <FileVersion>$(VersionPrefix).0</FileVersion>
    <CommitHash Condition="$(CommitHash) == ''">N/A</CommitHash>        
    <InformationalVersion>$(Version) Commit hash: $(CommitHash)</InformationalVersion>
    <CodeAnalysisRuleSet>$(MSBuildThisFileDirectory)..\src.ruleset</CodeAnalysisRuleSet>
    <NoWarn>$(NoWarn);NU1701</NoWarn>
    <DebugType>embedded</DebugType>
    <Deterministic>True</Deterministic>
    <NugetAudit>false</NugetAudit>
  </PropertyGroup>

  <PropertyGroup Condition="'$(UseSourceLink)' == 'true'">
    <SourceLink>$(BaseIntermediateOutputPath)source_link.json</SourceLink>
  </PropertyGroup>

  <PropertyGroup>
    <!--
      NOTE: source link does not actually work for v3.x in 1ES as the git remote url is Azure DevOps, not GitHub.
      However, we do not release public nuget packages from this branch anymore so it is not even used.
    -->
    <UseSourceLink Condition="$(UseSourceLink) == '' And $(CI) != ''">true</UseSourceLink>
  </PropertyGroup>

  <Target Name="GenerateSourceLink" BeforeTargets="CoreCompile" Condition="'$(UseSourceLink)' == 'true'">
    <PropertyGroup>
      <SrcRootDirectory>$([System.IO.Directory]::GetParent($(MSBuildThisFileDirectory.TrimEnd("\"))))</SrcRootDirectory>
      <SourceLinkRoot>$(SrcRootDirectory.Replace("\", "\\"))</SourceLinkRoot>
    </PropertyGroup>
    <Message Importance="high" Text="Generating SourceLink..."></Message>
    <Exec Command="git config --get remote.origin.url" ConsoleToMsBuild="true">
      <Output TaskParameter="ConsoleOutput" PropertyName="RemoteUri" />
    </Exec>

    <Exec Command="git rev-parse HEAD" ConsoleToMsBuild="true" Condition = " '$(LatestCommit)' == '' ">
      <Output TaskParameter="ConsoleOutput" PropertyName="LatestCommit" />
    </Exec>

    <!-- Write out the source file for this project to point at raw.githubusercontent.com -->
    <WriteLinesToFile File="$(BaseIntermediateOutputPath)source_link.json" Overwrite="true" Lines='{"documents": { "$(SourceLinkRoot)\\*" : "$(RemoteUri.Replace(".git", "").Replace("github.com", "raw.githubusercontent.com"))/$(LatestCommit)/*" }}' />
  </Target>
  
  <ItemGroup>
    <AdditionalFiles Include="$(MSBuildThisFileDirectory)..\stylecop.json" Link="stylecop.json" />
  </ItemGroup>

</Project>

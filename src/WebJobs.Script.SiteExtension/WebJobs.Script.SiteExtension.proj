<Project Sdk="Microsoft.Build.NoTargets">
  <Import Project="../../build/common.props" />
  <Import Project="../../build/workers.props" />

  <PropertyGroup>
    <TargetFramework>netstandard2.1</TargetFramework>
    <SiteExtensionName>Functions</SiteExtensionName>
    <PublishWebHostDependsOn>
      PublishProjectReferences;
      RemoveUnneededRuntimes;
      MoveSymbols;
      WriteHardLinkHashes;
    </PublishWebHostDependsOn>
  </PropertyGroup>

  <ItemGroup>
    <!-- We don't ship python with the site extension. -->
    <PackageReference Remove="Microsoft.Azure.Functions.PythonWorker" />
  </ItemGroup>

  <ItemGroup>
    <PublishRuntimeIdentifier Include="win-x86" SelfContained="false" PublishDir="32bit" />
    <PublishRuntimeIdentifier Include="win-x64" SelfContained="false" PublishDir="64bit" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="../WebJobs.Script.WebHost/WebJobs.Script.WebHost.csproj" ReferenceOutputAssembly="false" />
  </ItemGroup>

  <Import Project="Tasks.targets" />

  <!-- We set many properties and items in targets to ensure $(Version) is finalized. -->
  <Target Name="UpdatePaths" BeforeTargets="AddRuntimesToProjects;AssignTargetPaths">
    <PropertyGroup>
      <SiteExtensionRelativeDir>SiteExtension/$(Version)/</SiteExtensionRelativeDir>
      <SiteExtensionDir>$([MSBuild]::NormalizePath('$(PublishDir)$(SiteExtensionRelativeDir)'))</SiteExtensionDir>
    </PropertyGroup>
    <ItemGroup>
      <None Include="applicationHost.xdt" TargetPath="$(SiteExtensionRelativeDir)applicationHost.xdt" CopyToPublishDirectory="PreserveNewest" />
      <None Include="extension.xml" TargetPath="SiteExtension/extension.xml" CopyToPublishDirectory="PreserveNewest" />
    </ItemGroup>
  </Target>

  <Target Name="RemovePowershellWorkerRuntimes" BeforeTargets="UpdateWorkerPaths">
    <ItemGroup>
      <_KeepPowerShellRuntime Include="win;win-x86;win10-x86;win-x64;win10-x64" />
    </ItemGroup>

    <PropertyGroup>
      <!--
        Match files that start with "workers/powershell/{version}/runtimes" but also not one of the win runtimes we want to keep.
        1. Transform @(_KeepPowerShellRuntime) into a regex that matches runtime folders to keep, all or'd together.
        2. Build a regex that matches all runtimes except the runtimes folders from the first step.
      -->
      <_PowershellRuntimesToKeepRegex>@(_KeepPowerShellRuntime->'%(Identity)(/|\\)', '|')</_PowershellRuntimesToKeepRegex>
      <_PowershellRuntimesToRemoveRegex>^workers(/|\\)powershell(/|\\).*(/|\\)runtimes(/|\\)(?!$(_PowershellRuntimesToKeepRegex))</_PowershellRuntimesToRemoveRegex>
    </PropertyGroup>

    <ItemGroup>
      <_PowershellRuntimeToRemove Include="@(None)" Condition="'%(TargetPath)' != '' AND $([System.Text.RegularExpressions.Regex]::IsMatch('%(TargetPath)', $(_PowershellRuntimesToRemoveRegex)))" />
      <None Remove="@(_PowershellRuntimeToRemove)" />
    </ItemGroup>
  </Target>

  <Target Name="UpdateWorkerPaths" DependsOnTargets="UpdatePaths" BeforeTargets="AssignTargetPaths">
    <ItemGroup>
      <None Condition="'%(TargetPath)' != '' AND $([System.String]::new('%(TargetPath)').StartsWith('workers'))">
        <TargetPath>$(SiteExtensionRelativeDir)%(TargetPath)</TargetPath>
      </None>
    </ItemGroup>
  </Target>

  <Target Name="AddRuntimesToProjects" BeforeTargets="AssignProjectConfiguration">
    <ItemGroup>
      <_ProjectReferenceWithRuntimes Include="@(ProjectReference)">
        <AdditionalProperties>
          <!-- These properties will not be pass transitively and are safe for build. -->
          RuntimeIdentifier=%(PublishRuntimeIdentifier.Identity);
          SelfContained=%(PublishRuntimeIdentifier.SelfContained)
        </AdditionalProperties>
        <PublishAdditionalProperties>
          <!-- These properties will be passed transitively, so only add them right before publish. -->
          PublishDir=$(SiteExtensionDir)%(PublishRuntimeIdentifier.PublishDir)/;
          PublishWorkers=false;
          _IsPublishing=true
        </PublishAdditionalProperties>
        <Private>false</Private> <!-- Avoids including transitive output. -->
      </_ProjectReferenceWithRuntimes>
      <ProjectReference Remove="@(ProjectReference)" />
      <ProjectReference Include="@(_ProjectReferenceWithRuntimes)" />
    </ItemGroup>
  </Target>

  <Target Name="PublishWebHost" AfterTargets="PrepareForPublish" BeforeTargets="Publish" DependsOnTargets="$(PublishWebHostDependsOn)" />

  <Target Name="PublishProjectReferences" AfterTargets="PrepareForPublish" BeforeTargets="Publish">
    <ItemGroup>
      <_PublishProjectReferenceExistent Include="@(_MSBuildProjectReferenceExistent)">
        <AdditionalProperties>%(AdditionalProperties);%(PublishAdditionalProperties)</AdditionalProperties>
      </_PublishProjectReferenceExistent>
    </ItemGroup>
    <MSBuild Projects="@(_PublishProjectReferenceExistent)" Targets="Publish" BuildInParallel="$(BuildInParallel)" Properties="NoBuild=true" />
  </Target>

  <Target Name="RemoveUnneededRuntimes">
    <ItemGroup>
      <_RuntimesToRemove Include="@(PublishRuntimeIdentifier->'$(SiteExtensionDir)%(PublishDir)/runtimes/linux')" />
      <_RuntimesToRemove Include="@(PublishRuntimeIdentifier->'$(SiteExtensionDir)%(PublishDir)/runtimes/osx')" />
    </ItemGroup>
    <RemoveDir Directories="@(_RuntimesToRemove)" />
  </Target>

  <Target Name="MoveSymbols">
    <ItemGroup>
      <_SymbolDirs Include="@(PublishRuntimeIdentifier->'$(SiteExtensionDir)%(PublishDir)')">
        <Destination>$(PublishDir)Symbols/$(SiteExtensionName).Symbols.$(Version).%(Identity)</Destination>
      </_SymbolDirs>
      <_WorkerSymbols Include="$(SiteExtensionDir)workers/**/*.pdb" Destination="$(PublishDir)Symbols/$(SiteExtensionName).Symbols.$(Version).%(PublishRuntimeIdentifier.Identity)/workers" />
    </ItemGroup>
    <MoveSymbols Directories="@(_SymbolDirs)" Destinations="%(Destination)" />
    <Copy SourceFiles="@(_WorkerSymbols)" DestinationFiles="%(Destination)/%(RecursiveDir)%(Filename)%(Extension)" SkipUnchangedFiles="true" />
    <Delete Files="@(_WorkerSymbols)" />
  </Target>

  <Target Name="ComputeHardLinkHashes">
    <ItemGroup>
      <_FilesToHash Include="$(SiteExtensionDir)**" />
    </ItemGroup>
    <GetFileHash Files="@(_FilesToHash)" HashEncoding="base64">
      <Output TaskParameter="Items" ItemName="_HashedFiles" />
    </GetFileHash>
  </Target>

  <Target Name="WriteHardLinkHashes" DependsOnTargets="ComputeHardLinkHashes">
    <ItemGroup>
      <_HashedFiles RelativePath=".$([System.IO.Path]::DirectorySeparatorChar)$([MSBuild]::MakeRelative('$(SiteExtensionDir)', '%(Identity)'))" />
    </ItemGroup>
    <WriteLinesToFile
      Overwrite="true"
      File="$(SiteExtensionDir)/hashesForHardlinks.txt"
      Lines="@(_HashedFiles->'Hash: %(FileHash) FileName: %(RelativePath)')" />
  </Target>

</Project>
